<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retro Board</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f0f2f5;
    color: #1a1a2e;
    min-height: 100vh;
  }

  header h1 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2d3748;
    flex: 1;
  }

  #board-title { cursor: pointer; }
  #board-title:hover { text-decoration: underline; text-decoration-color: #cbd5e0; text-underline-offset: 3px; }
  #board-title.editing { cursor: default; text-decoration: none; }
  #board-title .title-input {
    font-family: inherit;
    font-size: 1.6rem;
    font-weight: 700;
    color: #2d3748;
    background: transparent;
    border: none;
    outline: 2px solid #667eea;
    border-radius: 4px;
    padding: 2px 6px;
    width: calc(50% - 80px);
    resize: none;
    overflow: hidden;
    line-height: 1.4;
    display: block;
  }

  .back-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #4a5568;
    display: flex;
    align-items: center;
    padding: 4px;
    border-radius: 6px;
    transition: background .15s;
  }
  .back-btn:hover { background: #e2e8f0; }

  /* --- Boards List View --- */
  .boards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
  }

  .board-tile {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    padding: 20px;
    cursor: pointer;
    transition: box-shadow .15s, transform .15s;
    position: relative;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.05rem;
    color: #2d3748;
  }
  .board-tile:hover { box-shadow: 0 4px 12px rgba(0,0,0,.12); transform: translateY(-2px); }

  .board-tile .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    cursor: pointer;
    color: #a0aec0;
    padding: 4px;
    border-radius: 4px;
    transition: color .15s, background .15s;
    display: flex;
    align-items: center;
  }
  .board-tile .delete-btn:hover { color: #e53e3e; background: #fee; }

  .board-tile .rename-btn {
    position: absolute;
    top: 8px;
    right: 36px;
    background: none;
    border: none;
    cursor: pointer;
    color: #a0aec0;
    padding: 4px;
    border-radius: 4px;
    transition: color .15s, background .15s;
    display: flex;
    align-items: center;
  }
  .board-tile .rename-btn:hover { color: #4299e1; background: #ebf8ff; }

  .create-board-btn {
    background: #fff;
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.05rem;
    color: #718096;
    transition: border-color .15s, color .15s;
  }
  .create-board-btn:hover { border-color: #667eea; color: #667eea; }

  /* --- Board Detail View --- */
  .board {
    display: flex;
    gap: 20px;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    align-items: flex-start;
  }

  .column {
    flex: 1;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    display: flex;
    flex-direction: column;
    min-height: 300px;
    transition: box-shadow .2s;
  }

  .column.drag-over {
    box-shadow: 0 0 0 2px #667eea, 0 4px 12px rgba(102,126,234,.25);
  }

  .column-header {
    padding: 14px 16px;
    font-weight: 600;
    font-size: .95rem;
    border-radius: 12px 12px 0 0;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sort-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: rgba(255,255,255,.7);
    padding: 2px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    transition: color .15s, background .15s;
  }

  .sort-btn:hover { color: #fff; background: rgba(255,255,255,.15); }

  .column[data-col="went-well"] .column-header  { background: #38a169; }
  .column[data-col="to-improve"] .column-header  { background: #d69e2e; }
  .column[data-col="action-items"] .column-header { background: #3182ce; }

  .cards {
    padding: 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .card {
    position: relative;
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 32px 10px 12px;
    min-height: 42px;
    font-size: .9rem;
    line-height: 1.4;
    word-wrap: break-word;
    white-space: pre-wrap;
    cursor: grab;
    transition: box-shadow .15s, opacity .15s;
  }

  .card:hover { box-shadow: 0 2px 6px rgba(0,0,0,.08); }
  .card.dragging { opacity: .4; }

  .card.placeholder {
    border-style: dashed;
    cursor: text;
    background: #fff;
  }

  .card.placeholder textarea {
    width: 100%;
    border: none;
    outline: none;
    resize: none;
    font: inherit;
    line-height: inherit;
    background: transparent;
    color: inherit;
    padding: 0;
  }

  .card .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    cursor: pointer;
    color: #a0aec0;
    transition: color .15s;
    line-height: 1;
    padding: 2px;
    display: flex;
    align-items: center;
  }
  .card .delete-btn:hover { color: #e53e3e; }

  .hidden { display: none !important; }

  /* --- Auth Views --- */
  .auth-logo {
    display: flex;
    justify-content: center;
    height: 120px;
    padding-top: 16px;
  }

  .auth-logo .top-bar-logo {
    position: static;
    transform: none;
  }

  .auth-container {
    max-width: 380px;
    margin: 24px auto 0;
    padding: 0 20px;
  }

  .auth-container h1 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2d3748;
    text-align: center;
    margin-bottom: 24px;
  }

  .auth-form {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .auth-form input {
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: .95rem;
    outline: none;
    transition: border-color .15s;
  }

  .auth-form input:focus { border-color: #667eea; }

  .auth-form button {
    padding: 10px;
    background: #667eea;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .15s;
  }

  .auth-form button:hover { background: #5a67d8; }

  .auth-error {
    color: #e53e3e;
    font-size: .85rem;
    display: none;
  }

  .auth-error.visible { display: block; }

  .auth-switch {
    text-align: center;
    margin-top: 14px;
    font-size: .88rem;
    color: #718096;
  }

  .auth-switch a {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
  }

  .auth-switch a:hover { text-decoration: underline; }

  /* --- Boards Header --- */
  .boards-header {
    padding: 16px 20px 0;
    max-width: 900px;
    margin: 0 auto;
  }

  .boards-header h1 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2d3748;
  }

  .welcome-text {
    font-size: .95rem;
    color: #718096;
    font-weight: 600;
    flex: 1;
  }

  .sign-out-btn {
    background: #667eea;
    border: none;
    border-radius: 6px;
    padding: 6px 14px;
    font-size: .85rem;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
    transition: background .15s;
  }

  .sign-out-btn:hover { background: #5a67d8; }

  /* --- Brand Logo --- */
  .top-bar-logo {
    height: 120px;
    width: auto;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 0;
  }

  /* --- Header wrappers --- */
  .boards-header-top {
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 16px;
    padding-top: 100px;
  }

  header {
    position: relative;
    padding: 100px 20px 8px;
    display: flex;
    align-items: flex-end;
    gap: 12px;
    max-width: 1200px;
    margin: 0 auto;
  }

  header .sign-out-btn {
    margin-left: auto;
  }

  /* --- Action Item Extra Fields --- */
  .action-fields {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 6px;
  }

  .action-fields input {
    width: 100%;
    padding: 5px 8px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: .82rem;
    outline: none;
  }

  .action-fields input:focus { border-color: #667eea; }

  .card-meta {
    font-size: .78rem;
    color: #718096;
    margin-top: 4px;
  }

  .card-meta span { margin-right: 10px; }

  /* --- Editable Card --- */
  .card.editing {
    cursor: default;
    padding-right: 12px;
  }

  .card.editing textarea {
    width: 100%;
    border: none;
    outline: none;
    resize: none;
    font: inherit;
    line-height: inherit;
    background: transparent;
    color: inherit;
    padding: 0;
  }

  /* --- Card Author --- */
  .card-author {
    font-size: .75rem;
    color: #a0aec0;
    margin-top: 4px;
  }

  /* --- Vote Bar --- */
  .vote-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
  }

  .vote-btn {
    background: none;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    cursor: pointer;
    padding: 3px 5px;
    line-height: 1;
    color: #4a5568;
    transition: background .15s, color .15s;
    display: flex;
    align-items: center;
  }

  .vote-btn:hover:not(.disabled) { background: #edf2f7; }

  .vote-btn.voted { color: #38a169; }

  .vote-btn.disabled {
    opacity: .35;
    pointer-events: none;
  }

  .vote-count {
    font-size: .8rem;
    font-weight: 600;
    color: #4a5568;
    min-width: 16px;
    text-align: center;
  }

  /* --- Help Page --- */
  .help-content {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 20px 40px;
    line-height: 1.6;
    color: #1a1a2e;
  }

  .help-content h1 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 12px;
  }

  .help-content h2 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2d3748;
    margin-top: 28px;
    margin-bottom: 12px;
  }

  .help-content p {
    font-size: .95rem;
    margin-bottom: 14px;
  }

  .help-btn {
    background: #667eea;
    border: none;
    border-radius: 6px;
    padding: 6px 14px;
    font-size: .85rem;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
    transition: background .15s;
  }

  .help-btn:hover { background: #5a67d8; }

  /* --- Footer --- */
  .footer {
    text-align: center;
    padding: 20px;
    font-size: .8rem;
    color: #a0aec0;
  }

  /* --- Toast --- */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #e53e3e;
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: .9rem;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    z-index: 200;
    opacity: 0;
    transition: opacity .2s;
  }

  .toast.visible { opacity: 1; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.4);
    justify-content: center;
    align-items: center;
    z-index: 100;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: #fff;
    border-radius: 12px;
    padding: 28px 32px;
    max-width: 380px;
    width: 90%;
    text-align: center;
    box-shadow: 0 8px 30px rgba(0,0,0,.18);
  }

  .modal h2 {
    font-size: 1.1rem;
    margin-bottom: 8px;
  }

  .modal p {
    font-size: .9rem;
    color: #718096;
    margin-bottom: 20px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .modal-actions button {
    padding: 8px 20px;
    border-radius: 6px;
    border: none;
    font-size: .9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background .15s;
  }

  .btn-cancel {
    background: #edf2f7;
    color: #4a5568;
  }
  .btn-cancel:hover { background: #e2e8f0; }

  .btn-proceed {
    background: #e53e3e;
    color: #fff;
  }
  .btn-proceed:hover { background: #c53030; }
</style>
</head>
<body>

<!-- ======== Sign In View ======== -->
<div id="view-signin" class="hidden">
  <div class="auth-logo"><img src="retro-buddy-logo-transparant.png" alt="Retro Buddy" class="top-bar-logo"></div>
  <div class="auth-container">
    <div class="auth-form" id="signin-form">
      <input type="email" id="signin-email" placeholder="Email address" autocomplete="email">
      <div class="auth-error" id="signin-error"></div>
      <button id="signin-btn">Sign In</button>
    </div>
    <div class="auth-switch">Don't have an account? <a id="goto-signup">Sign Up</a></div>
  </div>
  <div class="footer">Copyright Alan Gilbert 2026</div>
</div>

<!-- ======== Sign Up View ======== -->
<div id="view-signup" class="hidden">
  <div class="auth-logo"><img src="retro-buddy-logo-transparant.png" alt="Retro Buddy" class="top-bar-logo"></div>
  <div class="auth-container">
    <div class="auth-form" id="signup-form">
      <input type="email" id="signup-email" placeholder="Email address" autocomplete="email">
      <input type="text" id="signup-name" placeholder="Name / Nickname">
      <div class="auth-error" id="signup-error"></div>
      <button id="signup-btn">Sign Up</button>
    </div>
    <div class="auth-switch">Already have an account? <a id="goto-signin">Sign In</a></div>
  </div>
  <div class="footer">Copyright Alan Gilbert 2026</div>
</div>

<!-- ======== Boards List View ======== -->
<div id="view-boards" class="hidden">
  <div class="boards-header">
    <div class="boards-header-top">
      <img src="retro-buddy-logo-transparant.png" alt="Retro Buddy" class="top-bar-logo">
      <div class="welcome-text" id="welcome-text"></div>
      <button class="help-btn" id="help-btn">Help</button>
      <button class="sign-out-btn" id="sign-out-btn">Sign Out</button>
    </div>
  </div>
  <div class="boards-grid" id="boards-grid"></div>
  <div class="footer">Copyright Alan Gilbert 2026</div>
</div>

<!-- ======== Board Detail View ======== -->
<div id="view-board" class="hidden">
  <header>
    <img src="retro-buddy-logo-transparant.png" alt="Retro Buddy" class="top-bar-logo">
    <button class="back-btn" id="back-btn" title="Back to boards">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
    </button>
    <h1 id="board-title"></h1>
    <button class="help-btn" id="board-help-btn">Help</button>
    <button class="sign-out-btn" id="board-sign-out-btn">Sign Out</button>
  </header>
  <div class="board" id="board-columns">
    <div class="column" data-col="went-well">
      <div class="column-header">Went Well</div>
      <div class="cards"></div>
    </div>
    <div class="column" data-col="to-improve">
      <div class="column-header">To Improve</div>
      <div class="cards"></div>
    </div>
    <div class="column" data-col="action-items">
      <div class="column-header">Action Items</div>
      <div class="cards"></div>
    </div>
  </div>
  <div class="footer">Copyright Alan Gilbert 2026</div>
</div>

<!-- ======== Help View ======== -->
<div id="view-help" class="hidden">
  <header>
    <img src="retro-buddy-logo-transparant.png" alt="Retro Buddy" class="top-bar-logo">
    <button class="back-btn" id="help-back-btn" title="Back">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
    </button>
    <h1></h1>
    <button class="sign-out-btn" id="help-sign-out-btn">Sign Out</button>
  </header>
  <div class="help-content">
    <h1>Retro Buddy: Team Retrospective Instructions</h1>
    <p>Retro Buddy is an opinionated tool for running team retrospectives. It supports one workflow. If you need flexibility, use a tool like Reetro instead.</p>

    <h2>Before the Meeting</h2>
    <p><strong>Create the board.</strong> Set up a new board in preparation for your retrospective meeting.</p>
    <p><strong>Add cards.</strong> Team members create cards in the first two columns: things that went well and things that could be improved.</p>
    <p><strong>Check for duplicates.</strong> Before creating a new card, scan existing cards. If you find a similar one, edit it to add your thoughts instead of creating a duplicate.</p>
    <p><strong>Merge duplicates.</strong> The meeting leader reviews all cards and manually merges any that are duplicates or closely related. (Automatic merging is not available.)</p>

    <h2>During the Meeting</h2>
    <p><strong>Vote on priorities.</strong> Each team member votes on the cards they want to discuss by clicking the thumbs-up icon. Everyone gets five votes maximum, one per card. To remove a vote, click the thumbs-up again.</p>
    <p><strong>Sort by votes.</strong> Once voting is completed, click the up-arrow icon to sort cards in descending order by votes.</p>
    <p><strong>Discuss top items.</strong> The meeting leader facilitates discussion of the highest-voted cards, working within your time limit (typically 30-45 minutes). Ask the card creator to provide background on each item.</p>
    <p><strong>Celebrate wins.</strong> For things that went well, celebrate the success and create action items, if appropriate, to sustain or amplify the positive outcome.</p>
    <p><strong>Take action to make improvements.</strong> For things needing improvement, generate action items with clear owners and due dates for the next sprint.</p>

    <h2>After the Meeting</h2>
    <p><strong>Delete old boards.</strong> Meeting leader periodically removes outdated boards to reduce clutter.</p>
    <p><strong>Follow up on action items.</strong> Improvements from retrospectives happen by agreeing on actions and then doing them.</p>
  </div>
  <div class="footer">Copyright Alan Gilbert 2026</div>
</div>

<!-- ======== Delete Confirmation Modal ======== -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2 id="modal-title">Delete Card</h2>
    <p id="modal-message">Are you sure you want to delete this card?</p>
    <div class="modal-actions">
      <button class="btn-cancel" id="modal-cancel">Cancel</button>
      <button class="btn-proceed" id="modal-proceed">Proceed</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 2500);
  }

  function isDateValid(dateStr) {
    if (!dateStr) return true; // empty is OK
    const today = new Date().toISOString().split('T')[0];
    return dateStr >= today;
  }

  function generateClientId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }

  const TRASH_SVG = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>';
  const THUMBS_UP_OUTLINE_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88L14 10h5.83a2 2 0 011.92 2.56l-2.33 8A2 2 0 0117.5 22H4a2 2 0 01-2-2v-8a2 2 0 012-2h2.76a2 2 0 001.79-1.11L12 2a3.13 3.13 0 013 3.88z"/></svg>';
  const THUMBS_UP_SOLID_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88L14 10h5.83a2 2 0 011.92 2.56l-2.33 8A2 2 0 0117.5 22H4a2 2 0 01-2-2v-8a2 2 0 012-2h2.76a2 2 0 001.79-1.11L12 2a3.13 3.13 0 013 3.88z"/></svg>';
  const SORT_SVG = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l0 14"/><path d="M18 11l-6-6-6 6"/></svg>';
  const PENCIL_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';

  // --- API Helpers ---
  async function apiGet(url) {
    const res = await fetch(url);
    return res.json();
  }
  async function apiPost(url, body) {
    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    return res.json();
  }
  async function apiPut(url, body) {
    const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    return res.json();
  }
  async function apiDelete(url) {
    const res = await fetch(url, { method: 'DELETE' });
    return res.json();
  }
  async function apiPatch(url, body) {
    const res = await fetch(url, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    return res.json();
  }

  // --- Author Cache ---
  let authorCache = {};

  // --- Cookie Helpers ---
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
  }

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  }

  function deleteCookie(name) {
    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax';
  }

  // --- Current User ---
  async function getCurrentUser() {
    const res = await fetch('/api/me');
    if (!res.ok) return null;
    const data = await res.json();
    if (data.user) authorCache[data.user.email] = data.user.name;
    return data.user || null;
  }

  // --- Data ---
  let boards = [];
  let currentBoardId = null;
  let myTotalVotes = 0;
  let cardVotesMap = {};

  function getBoard(id) {
    return boards.find(b => b.id === id);
  }

  // --- Modal ---
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const btnCancel = document.getElementById('modal-cancel');
  const btnProceed = document.getElementById('modal-proceed');
  let pendingDeleteAction = null;

  function showModal(title, message, onConfirm) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    pendingDeleteAction = onConfirm;
    modal.classList.add('active');
  }

  function hideModal() {
    modal.classList.remove('active');
    pendingDeleteAction = null;
  }

  btnCancel.addEventListener('click', hideModal);
  btnProceed.addEventListener('click', () => {
    if (pendingDeleteAction) pendingDeleteAction();
    hideModal();
  });
  modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });

  // --- Auth UI ---
  const viewSignin = document.getElementById('view-signin');
  const viewSignup = document.getElementById('view-signup');

  document.getElementById('goto-signup').addEventListener('click', () => {
    hideAllViews();
    viewSignup.classList.remove('hidden');
    document.getElementById('signup-error').classList.remove('visible');
  });

  document.getElementById('goto-signin').addEventListener('click', () => {
    hideAllViews();
    viewSignin.classList.remove('hidden');
    document.getElementById('signin-error').classList.remove('visible');
  });

  document.getElementById('signin-btn').addEventListener('click', async () => {
    const email = document.getElementById('signin-email').value.trim().toLowerCase();
    const errEl = document.getElementById('signin-error');
    if (!email) { errEl.textContent = 'Please enter an email address.'; errEl.classList.add('visible'); return; }
    const result = await apiPost('/api/signin', { email });
    if (!result.ok) { errEl.textContent = result.error; errEl.classList.add('visible'); return; }
    authorCache[email] = result.user.name;
    setCookie('retroUser', email, 365);
    await showBoardsList();
  });

  document.getElementById('signin-email').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('signin-btn').click();
  });

  document.getElementById('signup-btn').addEventListener('click', async () => {
    const email = document.getElementById('signup-email').value.trim().toLowerCase();
    const name = document.getElementById('signup-name').value.trim();
    const errEl = document.getElementById('signup-error');
    if (!email) { errEl.textContent = 'Please enter an email address.'; errEl.classList.add('visible'); return; }
    if (!name) { errEl.textContent = 'Please enter a name or nickname.'; errEl.classList.add('visible'); return; }
    const result = await apiPost('/api/signup', { email, name });
    if (!result.ok) { errEl.textContent = result.error; errEl.classList.add('visible'); return; }
    authorCache[email] = name;
    setCookie('retroUser', email, 365);
    await showBoardsList();
  });

  document.getElementById('signup-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('signup-btn').click();
  });

  document.getElementById('sign-out-btn').addEventListener('click', () => {
    deleteCookie('retroUser');
    showSignIn();
  });

  document.getElementById('board-sign-out-btn').addEventListener('click', () => {
    deleteCookie('retroUser');
    showSignIn();
  });

  document.getElementById('help-sign-out-btn').addEventListener('click', () => {
    deleteCookie('retroUser');
    showSignIn();
  });

  document.getElementById('help-btn').addEventListener('click', showHelp);
  document.getElementById('board-help-btn').addEventListener('click', showHelp);
  document.getElementById('help-back-btn').addEventListener('click', returnFromHelp);

  // --- Navigation ---
  const viewBoards = document.getElementById('view-boards');
  const viewBoard = document.getElementById('view-board');
  const viewHelp = document.getElementById('view-help');
  let helpReturnView = null;

  function hideAllViews() {
    viewSignin.classList.add('hidden');
    viewSignup.classList.add('hidden');
    viewBoards.classList.add('hidden');
    viewBoard.classList.add('hidden');
    viewHelp.classList.add('hidden');
  }

  function showHelp() {
    // Remember which view to return to
    if (!viewBoards.classList.contains('hidden')) helpReturnView = 'boards';
    else if (!viewBoard.classList.contains('hidden')) helpReturnView = 'board';
    else helpReturnView = 'boards';
    stopPolling();
    hideAllViews();
    viewHelp.classList.remove('hidden');
  }

  function returnFromHelp() {
    hideAllViews();
    if (helpReturnView === 'board' && currentBoardId) {
      showBoard(currentBoardId);
    } else {
      showBoardsList();
    }
  }

  function showSignIn() {
    stopPolling();
    currentBoardId = null;
    location.hash = '';
    hideAllViews();
    viewSignin.classList.remove('hidden');
    document.getElementById('signin-error').classList.remove('visible');
    document.getElementById('signin-email').value = '';
  }

  async function showBoardsList() {
    const user = await getCurrentUser();
    if (!user) { showSignIn(); return; }
    currentBoardId = null;
    location.hash = '';
    hideAllViews();
    viewBoards.classList.remove('hidden');
    document.getElementById('welcome-text').textContent = 'Welcome, ' + user.name + '!';
    const data = await apiGet('/api/boards');
    boards = data.boards;
    lastBoardsListJSON = JSON.stringify(boards.map(b => ({ id: b.id, name: b.name })));
    renderBoardsList();
    startBoardsListPolling();
  }

  async function showBoard(id) {
    const user = await getCurrentUser();
    if (!user) { showSignIn(); return; }
    const data = await apiGet('/api/boards/' + id);
    if (data.error) { await showBoardsList(); return; }
    // Update local boards array with fresh data
    const idx = boards.findIndex(b => b.id === id);
    if (idx !== -1) boards[idx] = data.board; else boards.push(data.board);
    // Merge authors into cache
    Object.assign(authorCache, data.authors);
    myTotalVotes = data.myTotalVotes || 0;
    // Build cardVotesMap from board data
    cardVotesMap = {};
    for (const colId of Object.keys(data.board.columns)) {
      (data.board.columns[colId] || []).forEach(item => {
        if (item.cardId) cardVotesMap[item.cardId] = item.votes || {};
      });
    }
    currentBoardId = id;
    location.hash = 'board-' + id;
    hideAllViews();
    viewBoard.classList.remove('hidden');
    document.getElementById('board-title').textContent = data.board.name;
    lastBoardJSON = JSON.stringify(data.board.columns);
    renderBoardCards(data.board);
    startBoardPolling(id);
  }

  document.getElementById('back-btn').addEventListener('click', () => showBoardsList());

  document.getElementById('board-title').addEventListener('click', function () {
    const h1 = this;
    if (h1.classList.contains('editing')) return;
    const originalName = h1.textContent;
    let cancelled = false;

    const ta = document.createElement('textarea');
    ta.className = 'title-input';
    ta.value = originalName;
    ta.maxLength = 32;
    ta.rows = 1;

    const resize = () => { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; };

    h1.textContent = '';
    h1.classList.add('editing');
    h1.appendChild(ta);
    ta.focus();
    ta.select();
    resize();

    ta.addEventListener('input', resize);

    ta.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); ta.blur(); }
      if (e.key === 'Escape') { cancelled = true; ta.blur(); }
    });

    ta.addEventListener('blur', async () => {
      h1.classList.remove('editing');
      if (cancelled) { h1.textContent = originalName; return; }
      const newName = ta.value.replace(/[\r\n]+/g, ' ').trim();
      if (!newName || newName === originalName) { h1.textContent = originalName; return; }
      h1.textContent = newName;
      const result = await apiPatch('/api/boards/' + currentBoardId, { name: newName });
      if (!result.ok) {
        h1.textContent = originalName;
      } else {
        const idx = boards.findIndex(b => b.id === currentBoardId);
        if (idx !== -1) boards[idx].name = newName;
      }
    }, { once: true });
  });

  window.addEventListener('hashchange', async () => {
    const hash = location.hash.slice(1);
    if (hash.startsWith('board-')) {
      await showBoard(hash.slice(6));
    } else {
      const user = await getCurrentUser();
      if (user) { await showBoardsList(); } else { showSignIn(); }
    }
  });

  // --- Boards List Rendering ---
  function renderBoardsList() {
    const grid = document.getElementById('boards-grid');
    grid.innerHTML = '';

    boards.forEach(board => {
      const tile = document.createElement('div');
      tile.className = 'board-tile';
      tile.textContent = board.name;
      tile.addEventListener('click', () => showBoard(board.id));

      const rename = document.createElement('button');
      rename.className = 'rename-btn';
      rename.innerHTML = PENCIL_SVG;
      rename.title = 'Rename board';
      rename.addEventListener('click', async e => {
        e.stopPropagation();
        const newName = prompt('Board name:', board.name);
        if (!newName || !newName.trim() || newName.trim() === board.name) return;
        const trimmedName = newName.trim().slice(0, 32);
        const result = await apiPatch('/api/boards/' + board.id, { name: trimmedName });
        if (result.ok) {
          board.name = trimmedName;
          renderBoardsList();
        }
      });
      tile.appendChild(rename);

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.innerHTML = TRASH_SVG;
      del.title = 'Delete board';
      del.addEventListener('click', e => {
        e.stopPropagation();
        showModal('Delete Board', `Are you sure you want to delete "${board.name}"?`, async () => {
          await apiDelete('/api/boards/' + board.id);
          boards = boards.filter(b => b.id !== board.id);
          renderBoardsList();
        });
      });
      tile.appendChild(del);
      grid.appendChild(tile);
    });

    const createBtn = document.createElement('button');
    createBtn.className = 'create-board-btn';
    createBtn.textContent = '+ Create New Board';
    createBtn.addEventListener('click', async () => {
      const name = prompt('Board name:');
      if (!name || !name.trim()) return;
      const result = await apiPost('/api/boards', { name: name.trim().slice(0, 32) });
      boards.push(result.board);
      await showBoard(result.board.id);
    });
    grid.appendChild(createBtn);
  }

  // --- Board Detail Rendering ---
  function getAuthorName(email) {
    if (!email || email === 'unknown') return 'Unknown';
    return authorCache[email] || email;
  }

  function getVoteTotal(votes) {
    return Object.values(votes || {}).reduce((s, v) => s + v, 0);
  }

  function getMyVotesOnCard(votes) {
    const email = getCookie('retroUser') || '';
    return (votes && votes[email]) || 0;
  }

  function refreshVoteStates() {
    const email = getCookie('retroUser') || '';
    document.querySelectorAll('.card[data-card-id]').forEach(card => {
      const cardId = card.dataset.cardId;
      const votes = cardVotesMap[cardId] || {};
      const iVoted = !!votes[email];
      const countEl = card.querySelector('.vote-count');
      if (countEl) countEl.textContent = getVoteTotal(votes);
      const upBtn = card.querySelector('.vote-up');
      if (upBtn) {
        upBtn.innerHTML = iVoted ? THUMBS_UP_SOLID_SVG : THUMBS_UP_OUTLINE_SVG;
        if (iVoted) upBtn.classList.add('voted'); else upBtn.classList.remove('voted');
        // Disable if at limit and haven't voted on this card (can always un-vote)
        if (!iVoted && myTotalVotes >= 5) upBtn.classList.add('disabled');
        else upBtn.classList.remove('disabled');
      }
    });
  }

  async function castVote(cardId) {
    const result = await apiPost('/api/boards/' + currentBoardId + '/vote', { cardId });
    if (!result.ok) return;
    cardVotesMap[cardId] = result.votes;
    myTotalVotes = result.myTotalVotes;
    refreshVoteStates();
    // Fetch fresh board to update snapshot so polling doesn't fight with us
    try {
      const fresh = await apiGet('/api/boards/' + currentBoardId);
      if (fresh.board) lastBoardJSON = JSON.stringify(fresh.board.columns);
    } catch (e) { /* ignore */ }
  }

  function sortColumnByVotes(col) {
    const cardsContainer = col.querySelector('.cards');
    const cards = [...cardsContainer.querySelectorAll('.card:not(.placeholder)')];
    cards.sort((a, b) => {
      const votesA = getVoteTotal(cardVotesMap[a.dataset.cardId] || {});
      const votesB = getVoteTotal(cardVotesMap[b.dataset.cardId] || {});
      return votesB - votesA;
    });
    cards.forEach(card => cardsContainer.appendChild(card));
    saveBoardState();
  }

  function renderBoardCards(board) {
    document.querySelectorAll('#board-columns .column').forEach(col => {
      const colId = col.dataset.col;
      const header = col.querySelector('.column-header');
      const cardsContainer = col.querySelector('.cards');
      cardsContainer.innerHTML = '';

      // Add sort button to went-well and to-improve headers
      const existingSortBtn = header.querySelector('.sort-btn');
      if (existingSortBtn) existingSortBtn.remove();
      if (colId === 'went-well' || colId === 'to-improve') {
        const sortBtn = document.createElement('button');
        sortBtn.className = 'sort-btn';
        sortBtn.innerHTML = SORT_SVG;
        sortBtn.title = 'Sort by most votes';
        sortBtn.addEventListener('click', () => sortColumnByVotes(col));
        header.appendChild(sortBtn);
      }

      // Add placeholder at top
      cardsContainer.appendChild(createPlaceholder(colId));

      // Add saved cards
      (board.columns[colId] || []).forEach(item => {
        cardsContainer.appendChild(createFilledCard(item, colId));
      });
    });
    setupDragDrop();
  }

  async function saveBoardState() {
    if (!currentBoardId) return;
    const columns = {};
    document.querySelectorAll('#board-columns .column').forEach(col => {
      const colId = col.dataset.col;
      const cards = [];
      col.querySelectorAll('.cards .card:not(.placeholder)').forEach(card => {
        const text = card.querySelector('span').textContent;
        const author = card.dataset.author || 'unknown';
        const cardId = card.dataset.cardId || generateClientId();
        const item = { text, author, cardId, votes: cardVotesMap[cardId] || {} };
        if (colId === 'action-items') {
          item.responsible = card.dataset.responsible || '';
          item.dueDate = card.dataset.dueDate || '';
        }
        cards.push(item);
      });
      columns[colId] = cards;
    });
    await apiPut('/api/boards/' + currentBoardId, { columns });
    // Update snapshot so polling doesn't re-render our own save
    lastBoardJSON = JSON.stringify(columns);
  }

  // --- Card Creation ---
  function createPlaceholder(colId) {
    const card = document.createElement('div');
    card.className = 'card placeholder';
    card.dataset.colId = colId || '';
    const ta = document.createElement('textarea');
    ta.rows = 1;
    ta.placeholder = 'Add a note\u2026';
    ta.addEventListener('input', autoResize);
    ta.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        commitPlaceholder(card, true);
      }
    });
    ta.addEventListener('blur', e => {
      // Don't commit if focus moved to another input within the same placeholder
      if (colId === 'action-items' && card.contains(e.relatedTarget)) return;
      commitPlaceholder(card, false);
    });
    card.appendChild(ta);

    if (colId === 'action-items') {
      const fields = document.createElement('div');
      fields.className = 'action-fields';
      const respInput = document.createElement('input');
      respInput.type = 'text';
      respInput.placeholder = 'Responsible';
      respInput.className = 'action-responsible';
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.className = 'action-due-date';
      dateInput.title = 'Due date';
      dateInput.min = new Date().toISOString().split('T')[0];
      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
      dateInput.value = tomorrow.toISOString().split('T')[0];
      fields.appendChild(respInput);
      fields.appendChild(dateInput);
      card.appendChild(fields);

      // Also commit on Enter from these fields
      [respInput, dateInput].forEach(inp => {
        inp.addEventListener('keydown', e => {
          if (e.key === 'Enter') { e.preventDefault(); commitPlaceholder(card, true); }
        });
        inp.addEventListener('blur', e => {
          if (card.contains(e.relatedTarget)) return;
          commitPlaceholder(card, false);
        });
      });
    }

    return card;
  }

  function autoResize(e) {
    const ta = e.target;
    ta.style.height = 'auto';
    ta.style.height = ta.scrollHeight + 'px';
  }

  function startEditCard(card) {
    if (card.classList.contains('editing')) return;
    card.classList.add('editing');
    card.draggable = false;

    const colId = card.closest('.column').dataset.col;
    const currentText = card.querySelector('span').textContent;
    const currentResponsible = card.dataset.responsible || '';
    const currentDueDate = card.dataset.dueDate || '';
    const author = card.dataset.author || 'unknown';
    const cardId = card.dataset.cardId || generateClientId();
    const votes = cardVotesMap[cardId] || {};

    card.innerHTML = '';

    const ta = document.createElement('textarea');
    ta.value = currentText;
    ta.rows = 1;
    ta.style.height = 'auto';
    ta.addEventListener('input', autoResize);
    card.appendChild(ta);

    // Action-item fields
    let respInput, dateInput;
    if (colId === 'action-items') {
      const fields = document.createElement('div');
      fields.className = 'action-fields';
      respInput = document.createElement('input');
      respInput.type = 'text';
      respInput.placeholder = 'Responsible';
      respInput.className = 'action-responsible';
      respInput.value = currentResponsible;
      dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.className = 'action-due-date';
      dateInput.title = 'Due date';
      dateInput.min = new Date().toISOString().split('T')[0];
      dateInput.value = currentDueDate;
      fields.appendChild(respInput);
      fields.appendChild(dateInput);
      card.appendChild(fields);
    }

    function finishEdit() {
      if (card._editFinished) return;
      const newText = ta.value.trim();
      if (!newText) { card._editFinished = true; card.remove(); saveBoardState(); return; }

      if (colId === 'action-items' && dateInput && dateInput.value && !isDateValid(dateInput.value)) {
        showToast('Error: Invalid or past date.');
        dateInput.value = currentDueDate || '';
        return;
      }

      card._editFinished = true;
      const item = { text: newText, author, cardId, votes };
      if (colId === 'action-items') {
        item.responsible = respInput ? respInput.value.trim() : '';
        item.dueDate = dateInput ? dateInput.value : '';
      }

      const newCard = createFilledCard(item, colId);
      card.replaceWith(newCard);
      saveBoardState();
    }

    ta.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); finishEdit(); }
      if (e.key === 'Escape') finishEdit();
    });

    const blurHandler = e => {
      if (card.contains(e.relatedTarget)) return;
      finishEdit();
    };
    ta.addEventListener('blur', blurHandler);
    if (respInput) { respInput.addEventListener('blur', blurHandler); respInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); finishEdit(); } }); }
    if (dateInput) { dateInput.addEventListener('blur', blurHandler); dateInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); finishEdit(); } }); }

    // Focus and place cursor at end
    ta.focus();
    ta.selectionStart = ta.selectionEnd = ta.value.length;
    ta.style.height = ta.scrollHeight + 'px';
  }

  function createFilledCard(item, colId) {
    const text = typeof item === 'string' ? item : item.text;
    const author = typeof item === 'string' ? 'unknown' : (item.author || 'unknown');
    const cardId = (typeof item === 'object' && item.cardId) ? item.cardId : generateClientId();
    const votes = (typeof item === 'object' && item.votes) ? item.votes : {};

    // Store votes in map
    cardVotesMap[cardId] = votes;

    const card = document.createElement('div');
    card.className = 'card';
    card.draggable = true;
    card.dataset.author = author;
    card.dataset.cardId = cardId;

    if (item.responsible) card.dataset.responsible = item.responsible;
    if (item.dueDate) card.dataset.dueDate = item.dueDate;

    const span = document.createElement('span');
    span.textContent = text;
    card.appendChild(span);

    // Show responsible / due date for action-items
    if (colId === 'action-items' && (item.responsible || item.dueDate)) {
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      if (item.responsible) {
        const rs = document.createElement('span');
        rs.textContent = 'Owner: ' + item.responsible;
        meta.appendChild(rs);
      }
      if (item.dueDate) {
        const ds = document.createElement('span');
        ds.textContent = 'Due: ' + item.dueDate;
        meta.appendChild(ds);
      }
      card.appendChild(meta);
    }

    // Vote bar for went-well and to-improve only
    if (colId === 'went-well' || colId === 'to-improve') {
      const email = getCookie('retroUser') || '';
      const iVoted = !!votes[email];
      const voteBar = document.createElement('div');
      voteBar.className = 'vote-bar';

      const upBtn = document.createElement('button');
      upBtn.className = 'vote-btn vote-up' + (iVoted ? ' voted' : '') + (!iVoted && myTotalVotes >= 5 ? ' disabled' : '');
      upBtn.innerHTML = iVoted ? THUMBS_UP_SOLID_SVG : THUMBS_UP_OUTLINE_SVG;
      upBtn.title = 'Vote';
      upBtn.addEventListener('click', e => { e.stopPropagation(); castVote(cardId); });

      const countSpan = document.createElement('span');
      countSpan.className = 'vote-count';
      countSpan.textContent = getVoteTotal(votes);

      voteBar.appendChild(upBtn);
      voteBar.appendChild(countSpan);
      card.appendChild(voteBar);
    }

    const authorDiv = document.createElement('div');
    authorDiv.className = 'card-author';
    authorDiv.textContent = getAuthorName(author);
    card.appendChild(authorDiv);

    const btn = document.createElement('button');
    btn.className = 'delete-btn';
    btn.innerHTML = TRASH_SVG;
    btn.addEventListener('click', e => {
      e.stopPropagation();
      showModal('Delete Card', 'Are you sure you want to delete this card?', () => {
        card.remove();
        saveBoardState();
      });
    });
    card.appendChild(btn);

    span.style.cursor = 'pointer';
    span.addEventListener('click', e => {
      e.stopPropagation();
      startEditCard(card);
    });
    card.addEventListener('dragstart', onDragStart);
    card.addEventListener('dragend', onDragEnd);
    return card;
  }

  function commitPlaceholder(card, focusNew) {
    if (card._committed) return;
    const ta = card.querySelector('textarea');
    const text = ta.value.trim();
    if (!text) return;

    const colId = card.dataset.colId || '';
    const authorEmail = getCookie('retroUser') || 'unknown';

    // Read action-item fields before clearing
    let responsible = '';
    let dueDate = '';
    if (colId === 'action-items') {
      const respInput = card.querySelector('.action-responsible');
      const dateInput = card.querySelector('.action-due-date');
      if (respInput) responsible = respInput.value.trim();
      if (dateInput) dueDate = dateInput.value;
      if (dueDate && !isDateValid(dueDate)) {
        showToast('Error: Invalid or past date.');
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        dateInput.value = tomorrow.toISOString().split('T')[0];
        return;
      }
    }

    card._committed = true;

    // Convert placeholder to a filled card using createFilledCard
    const container = card.parentElement;
    const item = { text, author: authorEmail, cardId: generateClientId(), votes: {} };
    if (responsible) item.responsible = responsible;
    if (dueDate) item.dueDate = dueDate;

    const filledCard = createFilledCard(item, colId);
    card.replaceWith(filledCard);

    // Insert new placeholder at top
    const newPlaceholder = createPlaceholder(colId);
    container.insertBefore(newPlaceholder, container.firstChild);
    if (focusNew) newPlaceholder.querySelector('textarea').focus();

    saveBoardState();
  }

  // --- Drag and Drop ---
  let draggedCard = null;
  let dragSourceCol = null;

  function onDragStart(e) {
    draggedCard = e.target;
    dragSourceCol = e.target.closest('.column').dataset.col;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function onDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedCard = null;
    dragSourceCol = null;
    document.querySelectorAll('.column.drag-over').forEach(c => c.classList.remove('drag-over'));
  }

  function getDropTarget(container, y) {
    const cards = [...container.querySelectorAll('.card:not(.dragging):not(.placeholder)')];
    for (const card of cards) {
      const rect = card.getBoundingClientRect();
      if (y < rect.top + rect.height / 2) return card;
    }
    return null;
  }

  function isActionItemCrossMove(targetColId) {
    if (!dragSourceCol) return false;
    if (dragSourceCol === targetColId) return false;
    return dragSourceCol === 'action-items' || targetColId === 'action-items';
  }

  function setupDragDrop() {
    document.querySelectorAll('#board-columns .column').forEach(col => {
      col.addEventListener('dragover', e => {
        const targetColId = col.dataset.col;
        // Block cross-column moves involving action-items
        if (isActionItemCrossMove(targetColId)) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        col.classList.add('drag-over');
      });

      col.addEventListener('dragleave', e => {
        if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over');
      });

      col.addEventListener('drop', e => {
        const targetColId = col.dataset.col;
        if (isActionItemCrossMove(targetColId)) return;
        e.preventDefault();
        col.classList.remove('drag-over');
        if (!draggedCard) return;
        const cards = col.querySelector('.cards');
        const target = getDropTarget(cards, e.clientY);
        if (target) {
          cards.insertBefore(draggedCard, target);
        } else {
          cards.appendChild(draggedCard);
        }
        saveBoardState();
      });
    });
  }

  // --- Polling for live updates ---
  let pollTimer = null;
  let lastBoardJSON = '';

  function stopPolling() {
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
  }

  function startBoardPolling(boardId) {
    stopPolling();
    pollTimer = setInterval(async () => {
      if (!currentBoardId || currentBoardId !== boardId) { stopPolling(); return; }
      // Skip if user is editing or dragging
      if (document.querySelector('.card.editing') || document.querySelector('.card.placeholder textarea:focus') || draggedCard) return;
      try {
        const data = await apiGet('/api/boards/' + boardId);
        if (data.error || !data.board) return;
        const newJSON = JSON.stringify(data.board.columns);
        if (newJSON === lastBoardJSON) return;
        lastBoardJSON = newJSON;
        // Update state and re-render
        const idx = boards.findIndex(b => b.id === boardId);
        if (idx !== -1) boards[idx] = data.board; else boards.push(data.board);
        Object.assign(authorCache, data.authors);
        myTotalVotes = data.myTotalVotes || 0;
        cardVotesMap = {};
        for (const colId of Object.keys(data.board.columns)) {
          (data.board.columns[colId] || []).forEach(item => {
            if (item.cardId) cardVotesMap[item.cardId] = item.votes || {};
          });
        }
        document.getElementById('board-title').textContent = data.board.name;
        renderBoardCards(data.board);
      } catch (e) { /* ignore network errors */ }
    }, 4000);
  }

  let lastBoardsListJSON = '';

  function startBoardsListPolling() {
    stopPolling();
    pollTimer = setInterval(async () => {
      if (currentBoardId) { stopPolling(); return; }
      try {
        const data = await apiGet('/api/boards');
        const newJSON = JSON.stringify(data.boards.map(b => ({ id: b.id, name: b.name })));
        if (newJSON === lastBoardsListJSON) return;
        lastBoardsListJSON = newJSON;
        boards = data.boards;
        renderBoardsList();
      } catch (e) { /* ignore */ }
    }, 4000);
  }

  // --- Init ---
  (async () => {
    const user = await getCurrentUser();
    if (!user) {
      showSignIn();
    } else {
      const hash = location.hash.slice(1);
      if (hash.startsWith('board-')) {
        await showBoard(hash.slice(6));
      } else {
        await showBoardsList();
      }
    }
  })();
</script>
</body>
</html>
